<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Аналитический отчет - {{ file_name }}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f8f9fa;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        
        /* Заголовок отчета */
        .report-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }
        
        .report-header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .report-header .file-info {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        /* Панель инструментов */
        .toolbar {
            background: #fff;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .export-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        /* Краткое резюме */
        .executive-summary {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .summary-card .number {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
        }
        
        .summary-card .label {
            color: #6c757d;
            margin-top: 5px;
        }
        
        .key-insights {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .key-insights h3 {
            color: #495057;
            margin-bottom: 15px;
        }
        
        .insight-item {
            padding: 10px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .insight-item:last-child {
            border-bottom: none;
        }
        
        .insight-item::before {
            content: "→";
            color: #007bff;
            margin-right: 10px;
            font-weight: bold;
        }
        
        /* Навигация по разделам */
        .section-nav {
            background: #fff;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .nav-tabs {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .nav-tab {
            padding: 12px 20px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            color: #495057;
        }
        
        .nav-tab.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        
        .nav-tab:hover:not(.active) {
            background: #e9ecef;
        }
        
        /* Содержимое разделов */
        .section-content {
            padding: 30px;
            min-height: 500px;
        }
        
        .section {
            display: none;
        }
        
        .section.active {
            display: block;
        }
        
        .section h2 {
            color: #495057;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #007bff;
        }
        
        /* Визуализации */
        .visualization-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }
        
        .viz-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .viz-card:hover {
            transform: translateY(-5px);
        }
        
        .viz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .viz-title {
            font-weight: bold;
            color: #495057;
        }
        
        .viz-actions {
            display: flex;
            gap: 5px;
        }
        
        .btn-small {
            padding: 5px 10px;
            font-size: 0.8em;
        }
        
        .viz-image {
            width: 100%;
            height: auto;
            border-radius: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        /* Интерактивные карточки */
        .interactive-card {
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .interactive-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .interactive-preview {
            position: relative;
        }
        
        .overlay-hint {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 5px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .interactive-card:hover .overlay-hint {
            opacity: 1;
        }
        
        .hint-text {
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 500;
        }
        
        /* Заключение */
        .conclusion {
            background: #e8f5e8;
            padding: 30px;
            border-left: 5px solid #28a745;
            margin: 20px 0;
            border-radius: 8px;
        }
        
        .conclusion h3 {
            color: #155724;
            margin-bottom: 20px;
            font-size: 1.3em;
        }
        
        .conclusion ul {
            list-style: none;
            padding-left: 0;
            margin: 0;
        }
        
        .conclusion li {
            position: relative;
            padding-left: 25px;
            margin-bottom: 12px;
            line-height: 1.6;
            color: #2c5530;
        }
        
        .conclusion li:before {
            content: "—";
            position: absolute;
            left: 0;
            color: #28a745;
            font-weight: bold;
            font-size: 1.2em;
        }
        
        .conclusion li:last-child {
            margin-bottom: 0;
        }
        
        /* Стили для всех списков в заключении */
        #conclusion ul {
            list-style: none;
            padding-left: 0;
            margin: 15px 0;
        }
        
        #conclusion li {
            position: relative;
            padding-left: 25px;
            margin-bottom: 12px;
            line-height: 1.6;
            color: #495057;
        }
        
        #conclusion li:before {
            content: "—";
            position: absolute;
            left: 0;
            color: #007bff;
            font-weight: bold;
            font-size: 1.2em;
        }
        
        #conclusion li:last-child {
            margin-bottom: 0;
        }
        
        #conclusion h3 {
            color: #495057;
            margin: 25px 0 15px 0;
            font-size: 1.3em;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 8px;
        }
        
        #conclusion p {
            line-height: 1.6;
            color: #6c757d;
            margin-bottom: 15px;
        }
        
        #conclusion strong {
            color: #495057;
        }
        
        /* Статистические таблицы */
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        .stats-table th,
        .stats-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        
        .stats-table th {
            background: #f8f9fa;
            font-weight: bold;
        }
        
        /* Модальное окно для интерактивных графиков */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            position: relative;
            margin: 2% auto;
            width: 95%;
            height: 90%;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: modalFadeIn 0.3s ease-out;
        }
        
        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            background: #f8f9fa;
            border-radius: 10px 10px 0 0;
        }
        
        .modal-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #495057;
        }
        
        .modal-close {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.2em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .modal-close:hover {
            background: #c82333;
            transform: scale(1.1);
        }
        
        .modal-body {
            height: calc(100% - 80px);
            padding: 0;
        }
        
        .modal-iframe {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 0 0 10px 10px;
        }
        
        /* Адаптивность */
        @media (max-width: 768px) {
            .toolbar {
                flex-direction: column;
                align-items: stretch;
            }
            
            .export-buttons {
                justify-content: center;
            }
            
            .nav-tabs {
                justify-content: center;
            }
            
            .visualization-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                width: 98%;
                height: 95%;
                margin: 1% auto;
            }
        }
        
        /* Печать */
        @media print {
            .toolbar,
            .nav-tabs {
                display: none;
            }
            
            .section {
                display: block !important;
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Заголовок отчета -->
        <div class="report-header">
            <h1>📊 Аналитический отчет</h1>
            <div class="file-info">
                <p><strong>Файл:</strong> {{ file_name }}</p>
                <p><strong>Дата анализа:</strong> {{ created_at }}</p>
                <p><strong>ID анализа:</strong> {{ analysis_id }}</p>
            </div>
        </div>

        <!-- Панель инструментов -->
        <div class="toolbar">
            <div class="export-buttons">
                <button class="btn btn-primary" onclick="exportToPDF()">
                    📄 Экспорт в PDF
                </button>
                <button class="btn btn-success" onclick="exportToDOCX()">
                    📝 Экспорт в Word
                </button>
                <button class="btn btn-warning" onclick="exportToExcel()">
                    📊 Экспорт в Excel
                </button>
                <button class="btn btn-danger" onclick="printReport()">
                    🖨️ Печать
                </button>
            </div>
            <div>
                <button class="btn btn-primary" onclick="copyAllGraphs()">
                    📋 Копировать все графики
                </button>
            </div>
        </div>

        <!-- Краткое резюме -->
        <div class="executive-summary">
            <h2>📋 Краткое резюме</h2>
            <div class="summary-grid">
                <div class="summary-card">
                    <div class="number">{{ stats.row_count }}</div>
                    <div class="label">Строк данных</div>
                </div>
                <div class="summary-card">
                    <div class="number">{{ stats.column_count }}</div>
                    <div class="label">Столбцов</div>
                </div>
                <div class="summary-card">
                    <div class="number">{{ numerical_count }}</div>
                    <div class="label">Числовых переменных</div>
                </div>
                <div class="summary-card">
                    <div class="number">{{ categorical_count }}</div>
                    <div class="label">Категориальных переменных</div>
                </div>
            </div>
            
            <div class="key-insights">
                <h3>🔍 Ключевые выводы</h3>
                {% if insights %}
                    {% for insight in insights %}
                        <div class="insight-item">{{ insight }}</div>
                    {% endfor %}
                {% else %}
                    <div class="insight-item">Данные успешно обработаны и проанализированы</div>
                    <div class="insight-item">Созданы визуализации для всех типов переменных</div>
                    <div class="insight-item">Выполнен корреляционный анализ числовых переменных</div>
                {% endif %}
            </div>
        </div>

        <!-- Навигация по разделам -->
        <div class="section-nav">
            <div class="nav-tabs">
                <a href="#overview" class="nav-tab active" onclick="showSection('overview')">📊 Обзор данных</a>
                <a href="#distributions" class="nav-tab" onclick="showSection('distributions')">📈 Распределения</a>
                <a href="#correlations" class="nav-tab" onclick="showSection('correlations')">🔗 Корреляции</a>
                <a href="#categorical" class="nav-tab" onclick="showSection('categorical')">📊 Категориальные данные</a>
                <a href="#timeseries" class="nav-tab" onclick="showSection('timeseries')">📅 Временные ряды</a>
                <a href="#outliers" class="nav-tab" onclick="showSection('outliers')">⚠️ Выбросы</a>
                <a href="#advanced" class="nav-tab" onclick="showSection('advanced')">🔬 Продвинутый анализ</a>
                <a href="#conclusion" class="nav-tab" onclick="showSection('conclusion')">📝 Заключение</a>
            </div>
        </div>

        <!-- Содержимое разделов -->
        <div class="section-content">
            <!-- Обзор данных -->
            <div id="overview" class="section active">
                <h2>📊 Обзор данных</h2>
                <p>В данном разделе представлена общая информация о структуре и качестве данных.</p>
                
                <h3>Статистика по столбцам</h3>
                {% if stats.numeric_stats %}
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th>Столбец</th>
                            <th>Среднее</th>
                            <th>Медиана</th>
                            <th>Стандартное отклонение</th>
                            <th>Минимум</th>
                            <th>Максимум</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for col, stats_data in stats.numeric_stats.items() %}
                        <tr>
                            <td><strong>{{ col }}</strong></td>
                            <td>{{ "%.2f"|format(stats_data.mean) if stats_data.mean else "N/A" }}</td>
                            <td>{{ "%.2f"|format(stats_data['50%']) if stats_data['50%'] else "N/A" }}</td>
                            <td>{{ "%.2f"|format(stats_data.std) if stats_data.std else "N/A" }}</td>
                            <td>{{ "%.2f"|format(stats_data.min) if stats_data.min else "N/A" }}</td>
                            <td>{{ "%.2f"|format(stats_data.max) if stats_data.max else "N/A" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% endif %}
                
                <h3>Пропущенные значения</h3>
                {% if stats.missing_values %}
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th>Столбец</th>
                            <th>Количество пропусков</th>
                            <th>Процент</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for col, count in stats.missing_values.items() %}
                        <tr>
                            <td><strong>{{ col }}</strong></td>
                            <td>{{ count }}</td>
                            <td>{{ "%.1f"|format(count / stats.row_count * 100) }}%</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% endif %}
            </div>

            <!-- Распределения -->
            <div id="distributions" class="section">
                <h2>📈 Анализ распределений</h2>
                <p>Интерактивные графики показывают, как распределены значения в числовых переменных. Нажмите на график для увеличения.</p>
                <div class="visualization-grid">
                    {% for viz in visualizations %}
                        {% if viz.type == 'interactive_distribution' %}
                            <div class="viz-card interactive-card" onclick="openInteractiveModal('{{ viz.path }}', '{{ viz.type }}', '{{ viz.column }}', '', '')">
                                <div class="viz-header">
                                    <div class="viz-title">Распределение: {{ viz.column }}</div>
                                    <div class="viz-actions">
                                        <button class="btn btn-small btn-primary" onclick="event.stopPropagation(); copyInteractiveGraph('{{ viz.path }}')">📋 Копировать</button>
                                        <button class="btn btn-small btn-success" onclick="event.stopPropagation(); downloadInteractiveGraph('{{ viz.path }}')">💾 Скачать</button>
                                    </div>
                                </div>
                                <div class="interactive-preview">
                                    <iframe src="/static/analyses/{{ analysis_id }}/{{ viz.path }}" 
                                            width="100%" 
                                            height="300px" 
                                            frameborder="0"
                                            style="border-radius: 5px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); pointer-events: none;">
                                    </iframe>
                                    <div class="overlay-hint">
                                        <div class="hint-text">👆 Нажмите для увеличения</div>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>

            <!-- Корреляции -->
            <div id="correlations" class="section">
                <h2>🔗 Корреляционный анализ</h2>
                <p>Интерактивный анализ связей между числовыми переменными. Нажмите на график для увеличения.</p>
                <div class="visualization-grid">
                    {% for viz in visualizations %}
                        {% if viz.type == 'interactive_correlation' %}
                            <div class="viz-card interactive-card" onclick="openInteractiveModal('{{ viz.path }}', '{{ viz.type }}', '', '', '')">
                                <div class="viz-header">
                                    <div class="viz-title">Корреляционная матрица</div>
                                    <div class="viz-actions">
                                        <button class="btn btn-small btn-primary" onclick="event.stopPropagation(); copyInteractiveGraph('{{ viz.path }}')">📋 Копировать</button>
                                        <button class="btn btn-small btn-success" onclick="event.stopPropagation(); downloadInteractiveGraph('{{ viz.path }}')">💾 Скачать</button>
                                    </div>
                                </div>
                                <div class="interactive-preview">
                                    <iframe src="/static/analyses/{{ analysis_id }}/{{ viz.path }}" 
                                            width="100%" 
                                            height="300px" 
                                            frameborder="0"
                                            style="border-radius: 5px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); pointer-events: none;">
                                    </iframe>
                                    <div class="overlay-hint">
                                        <div class="hint-text">👆 Нажмите для увеличения</div>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                        {% if viz.type == 'interactive_scatter' %}
                            <div class="viz-card interactive-card" onclick="openInteractiveModal('{{ viz.path }}', '{{ viz.type }}', '', '{{ viz.x_column }}', '{{ viz.y_column }}')">
                                <div class="viz-header">
                                    <div class="viz-title">{{ viz.x_column }} vs {{ viz.y_column }}</div>
                                    <div class="viz-actions">
                                        <button class="btn btn-small btn-primary" onclick="event.stopPropagation(); copyInteractiveGraph('{{ viz.path }}')">📋 Копировать</button>
                                        <button class="btn btn-small btn-success" onclick="event.stopPropagation(); downloadInteractiveGraph('{{ viz.path }}')">💾 Скачать</button>
                                    </div>
                                </div>
                                <div class="interactive-preview">
                                    <iframe src="/static/analyses/{{ analysis_id }}/{{ viz.path }}" 
                                            width="100%" 
                                            height="300px" 
                                            frameborder="0"
                                            style="border-radius: 5px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); pointer-events: none;">
                                    </iframe>
                                    <div class="overlay-hint">
                                        <div class="hint-text">👆 Нажмите для увеличения</div>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>

            <!-- Категориальные данные -->
            <div id="categorical" class="section">
                <h2>📊 Анализ категориальных данных</h2>
                <p>Интерактивные графики для анализа категориальных переменных. Нажмите на график для увеличения.</p>
                <div class="visualization-grid">
                    {% for viz in visualizations %}
                        {% if viz.type == 'interactive_bar' %}
                            <div class="viz-card interactive-card" onclick="openInteractiveModal('{{ viz.path }}', '{{ viz.type }}', '{{ viz.column }}', '', '')">
                                <div class="viz-header">
                                    <div class="viz-title">Категории: {{ viz.column }}</div>
                                    <div class="viz-actions">
                                        <button class="btn btn-small btn-primary" onclick="event.stopPropagation(); copyInteractiveGraph('{{ viz.path }}')">📋 Копировать</button>
                                        <button class="btn btn-small btn-success" onclick="event.stopPropagation(); downloadInteractiveGraph('{{ viz.path }}')">💾 Скачать</button>
                                    </div>
                                </div>
                                <div class="interactive-preview">
                                    <iframe src="/static/analyses/{{ analysis_id }}/{{ viz.path }}" 
                                            width="100%" 
                                            height="300px" 
                                            frameborder="0"
                                            style="border-radius: 5px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); pointer-events: none;">
                                    </iframe>
                                    <div class="overlay-hint">
                                        <div class="hint-text">👆 Нажмите для увеличения</div>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>

            <!-- Временные ряды -->
            <div id="timeseries" class="section">
                <h2>📅 Временные ряды</h2>
                <p>Интерактивный анализ изменений во времени. Нажмите на график для увеличения.</p>
                <div class="visualization-grid">
                    {% for viz in visualizations %}
                        {% if viz.type == 'interactive_time_series' %}
                            <div class="viz-card interactive-card" onclick="openInteractiveModal('{{ viz.path }}', '{{ viz.type }}', '', '{{ viz.x_column }}', '{{ viz.y_column }}')">
                                <div class="viz-header">
                                    <div class="viz-title">{{ viz.y_column }} по {{ viz.x_column }}</div>
                                    <div class="viz-actions">
                                        <button class="btn btn-small btn-primary" onclick="event.stopPropagation(); copyInteractiveGraph('{{ viz.path }}')">📋 Копировать</button>
                                        <button class="btn btn-small btn-success" onclick="event.stopPropagation(); downloadInteractiveGraph('{{ viz.path }}')">💾 Скачать</button>
                                    </div>
                                </div>
                                <div class="interactive-preview">
                                    <iframe src="/static/analyses/{{ analysis_id }}/{{ viz.path }}" 
                                            width="100%" 
                                            height="300px" 
                                            frameborder="0"
                                            style="border-radius: 5px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); pointer-events: none;">
                                    </iframe>
                                    <div class="overlay-hint">
                                        <div class="hint-text">👆 Нажмите для увеличения</div>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>

            <!-- Выбросы -->
            <div id="outliers" class="section">
                <h2>⚠️ Анализ выбросов</h2>
                <p>Интерактивный анализ аномальных значений в данных. Нажмите на график для увеличения.</p>
                <div class="visualization-grid">
                    {% for viz in visualizations %}
                        {% if viz.type == 'interactive_box' %}
                            <div class="viz-card interactive-card" onclick="openInteractiveModal('{{ viz.path }}', '{{ viz.type }}', '{{ viz.column }}', '', '')">
                                <div class="viz-header">
                                    <div class="viz-title">Box Plot: {{ viz.column }}</div>
                                    <div class="viz-actions">
                                        <button class="btn btn-small btn-primary" onclick="event.stopPropagation(); copyInteractiveGraph('{{ viz.path }}')">📋 Копировать</button>
                                        <button class="btn btn-small btn-success" onclick="event.stopPropagation(); downloadInteractiveGraph('{{ viz.path }}')">💾 Скачать</button>
                                    </div>
                                </div>
                                <div class="interactive-preview">
                                    <iframe src="/static/analyses/{{ analysis_id }}/{{ viz.path }}" 
                                            width="100%" 
                                            height="300px" 
                                            frameborder="0"
                                            style="border-radius: 5px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); pointer-events: none;">
                                    </iframe>
                                    <div class="overlay-hint">
                                        <div class="hint-text">👆 Нажмите для увеличения</div>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>

            <!-- Продвинутый анализ -->
            <div id="advanced" class="section">
                <h2>🔬 Продвинутый анализ</h2>
                <p>Интерактивные продвинутые методы анализа данных: 3D кластеризация, параллельные координаты, scatter matrix и статистические тесты.</p>
                <div class="visualization-grid">
                    {% for viz in visualizations %}
                        {% if viz.type == '3d_scatter' %}
                            <div class="viz-card interactive-card" onclick="openInteractiveModal('{{ viz.path }}', '{{ viz.type }}', '', '', '')">
                                <div class="viz-header">
                                    <div class="viz-title">3D Scatter Plot с кластеризацией</div>
                                    <div class="viz-actions">
                                        <button class="btn btn-small btn-primary" onclick="event.stopPropagation(); copyInteractiveGraph('{{ viz.path }}')">📋 Копировать</button>
                                        <button class="btn btn-small btn-success" onclick="event.stopPropagation(); downloadInteractiveGraph('{{ viz.path }}')">💾 Скачать</button>
                                    </div>
                                </div>
                                <div class="interactive-preview">
                                    <iframe src="/static/analyses/{{ analysis_id }}/{{ viz.path }}" 
                                            width="100%" 
                                            height="300px" 
                                            frameborder="0"
                                            style="border-radius: 5px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); pointer-events: none;">
                                    </iframe>
                                    <div class="overlay-hint">
                                        <div class="hint-text">👆 Нажмите для увеличения</div>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                        {% if viz.type == 'parallel_coordinates' %}
                            <div class="viz-card interactive-card" onclick="openInteractiveModal('{{ viz.path }}', '{{ viz.type }}', '', '', '')">
                                <div class="viz-header">
                                    <div class="viz-title">Parallel Coordinates Plot</div>
                                    <div class="viz-actions">
                                        <button class="btn btn-small btn-primary" onclick="event.stopPropagation(); copyInteractiveGraph('{{ viz.path }}')">📋 Копировать</button>
                                        <button class="btn btn-small btn-success" onclick="event.stopPropagation(); downloadInteractiveGraph('{{ viz.path }}')">💾 Скачать</button>
                                    </div>
                                </div>
                                <div class="interactive-preview">
                                    <iframe src="/static/analyses/{{ analysis_id }}/{{ viz.path }}" 
                                            width="100%" 
                                            height="300px" 
                                            frameborder="0"
                                            style="border-radius: 5px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); pointer-events: none;">
                                    </iframe>
                                    <div class="overlay-hint">
                                        <div class="hint-text">👆 Нажмите для увеличения</div>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                        {% if viz.type == 'scatter_matrix' %}
                            <div class="viz-card interactive-card" onclick="openInteractiveModal('{{ viz.path }}', '{{ viz.type }}', '', '', '')">
                                <div class="viz-header">
                                    <div class="viz-title">Scatter Matrix</div>
                                    <div class="viz-actions">
                                        <button class="btn btn-small btn-primary" onclick="event.stopPropagation(); copyInteractiveGraph('{{ viz.path }}')">📋 Копировать</button>
                                        <button class="btn btn-small btn-success" onclick="event.stopPropagation(); downloadInteractiveGraph('{{ viz.path }}')">💾 Скачать</button>
                                    </div>
                                </div>
                                <div class="interactive-preview">
                                    <iframe src="/static/analyses/{{ analysis_id }}/{{ viz.path }}" 
                                            width="100%" 
                                            height="300px" 
                                            frameborder="0"
                                            style="border-radius: 5px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); pointer-events: none;">
                                    </iframe>
                                    <div class="overlay-hint">
                                        <div class="hint-text">👆 Нажмите для увеличения</div>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                        {% if viz.type == 'qq_plot' %}
                            <div class="viz-card interactive-card" onclick="openInteractiveModal('{{ viz.path }}', '{{ viz.type }}', '{{ viz.column }}', '', '')">
                                <div class="viz-header">
                                    <div class="viz-title">Q-Q Plot: {{ viz.column }}</div>
                                    <div class="viz-actions">
                                        <button class="btn btn-small btn-primary" onclick="event.stopPropagation(); copyInteractiveGraph('{{ viz.path }}')">📋 Копировать</button>
                                        <button class="btn btn-small btn-success" onclick="event.stopPropagation(); downloadInteractiveGraph('{{ viz.path }}')">💾 Скачать</button>
                                    </div>
                                </div>
                                <div class="interactive-preview">
                                    <iframe src="/static/analyses/{{ analysis_id }}/{{ viz.path }}" 
                                            width="100%" 
                                            height="300px" 
                                            frameborder="0"
                                            style="border-radius: 5px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); pointer-events: none;">
                                    </iframe>
                                    <div class="overlay-hint">
                                        <div class="hint-text">👆 Нажмите для увеличения</div>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>

            <!-- Заключение -->
            <div id="conclusion" class="section">
                <h2>📝 Заключение и рекомендации</h2>
                
                <div class="conclusion">
                    <h3>🎯 Основные выводы</h3>
                    <ul>
                        {% if insights %}
                            {% for insight in insights %}
                                <li>{{ insight }}</li>
                            {% endfor %}
                        {% else %}
                            <li>Данные успешно обработаны и проанализированы</li>
                            <li>Созданы визуализации для всех типов переменных</li>
                            <li>Выполнен корреляционный анализ числовых переменных</li>
                            <li>Проведен анализ выбросов и аномалий</li>
                        {% endif %}
                    </ul>
                </div>

                <h3>📋 Рекомендации</h3>
                <div class="recommendations">
                    <p><strong>Для дальнейшего анализа рекомендуется:</strong></p>
                    <ul>
                        <li>Изучить детальные графики распределений для понимания структуры данных</li>
                        <li>Обратить внимание на выявленные выбросы и аномалии</li>
                        <li>Использовать найденные корреляции для построения прогнозных моделей</li>
                        <li>Рассмотреть возможность сегментации данных на основе кластерного анализа</li>
                    </ul>
                </div>

                <h3>📊 Методология</h3>
                <p>Данный отчет был создан с использованием автоматизированной системы анализа данных, включающей:</p>
                <ul>
                    <li>Статистический анализ и описательную статистику</li>
                    <li>Визуализацию данных с помощью современных библиотек</li>
                    <li>Корреляционный анализ для выявления связей</li>
                    <li>Анализ выбросов и аномалий</li>
                    <li>Кластерный анализ для группировки данных</li>
                    <li>Анализ временных рядов (при наличии временных данных)</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Модальное окно для интерактивных графиков -->
    <div id="interactiveModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Интерактивный график</div>
                <button class="modal-close" onclick="closeInteractiveModal()">&times;</button>
            </div>
            <div class="modal-body">
                <iframe id="modalIframe" class="modal-iframe" src=""></iframe>
            </div>
        </div>
    </div>

    <script>
        // Навигация по разделам
        function showSection(sectionId) {
            // Скрываем все разделы
            const sections = document.querySelectorAll('.section');
            sections.forEach(section => {
                section.classList.remove('active');
            });
            
            // Убираем активный класс со всех вкладок
            const tabs = document.querySelectorAll('.nav-tab');
            tabs.forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Показываем выбранный раздел
            document.getElementById(sectionId).classList.add('active');
            
            // Добавляем активный класс к вкладке
            event.target.classList.add('active');
        }

        // Копирование графика
        function copyGraph(imagePath) {
            const img = document.querySelector(`img[src="/static/analyses/{{ analysis_id }}/${imagePath}"]`);
            if (img) {
                // Создаем canvas для копирования
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = img.naturalWidth;
                canvas.height = img.naturalHeight;
                ctx.drawImage(img, 0, 0);
                
                canvas.toBlob(function(blob) {
                    const item = new ClipboardItem({ "image/png": blob });
                    navigator.clipboard.write([item]).then(function() {
                        alert('График скопирован в буфер обмена!');
                    });
                });
            }
        }

        // Скачивание графика
        function downloadGraph(imagePath) {
            const link = document.createElement('a');
            link.href = `/static/analyses/{{ analysis_id }}/${imagePath}`;
            link.download = imagePath;
            link.click();
        }

        // Копирование всех графиков
        function copyAllGraphs() {
            alert('Функция копирования всех графиков будет реализована в следующей версии');
        }

        // Экспорт в PDF
        function exportToPDF() {
            window.print();
        }

        // Экспорт в Word
        function exportToDOCX() {
            alert('Функция экспорта в Word будет реализована в следующей версии');
        }

        // Экспорт в Excel
        function exportToExcel() {
            alert('Функция экспорта в Excel будет реализована в следующей версии');
        }

        // Печать отчета
        function printReport() {
            window.print();
        }

        // Открытие модального окна с интерактивным графиком
        function openInteractiveModal(graphPath, graphType, column, xColumn, yColumn) {
            const modal = document.getElementById('interactiveModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalIframe = document.getElementById('modalIframe');
            
            // Устанавливаем заголовок
            let title = 'Интерактивный график';
            if (graphType === 'interactive_distribution') {
                title = `Распределение: ${column}`;
            } else if (graphType === 'interactive_correlation') {
                title = 'Корреляционная матрица';
            } else if (graphType === 'interactive_scatter') {
                title = `${xColumn} vs ${yColumn}`;
            } else if (graphType === 'interactive_bar') {
                title = `Категории: ${column}`;
            } else if (graphType === 'interactive_time_series') {
                title = `Временной ряд: ${yColumn}`;
            } else if (graphType === 'interactive_box') {
                title = `Box Plot: ${column}`;
            }
            
            modalTitle.textContent = title;
            
            // Устанавливаем источник iframe
            modalIframe.src = `/static/analyses/{{ analysis_id }}/${graphPath}`;
            
            // Показываем модальное окно
            modal.style.display = 'block';
            
            // Блокируем прокрутку страницы
            document.body.style.overflow = 'hidden';
        }

        // Закрытие модального окна
        function closeInteractiveModal() {
            const modal = document.getElementById('interactiveModal');
            const modalIframe = document.getElementById('modalIframe');
            
            // Очищаем iframe
            modalIframe.src = '';
            
            // Скрываем модальное окно
            modal.style.display = 'none';
            
            // Восстанавливаем прокрутку страницы
            document.body.style.overflow = 'auto';
        }

        // Закрытие модального окна при клике вне его
        window.onclick = function(event) {
            const modal = document.getElementById('interactiveModal');
            if (event.target === modal) {
                closeInteractiveModal();
            }
        }

        // Закрытие модального окна по клавише Escape
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeInteractiveModal();
            }
        });

        // Скачивание интерактивного графика
        function downloadInteractiveGraph(graphPath) {
            const link = document.createElement('a');
            link.href = `/static/analyses/{{ analysis_id }}/${graphPath}`;
            link.download = graphPath;
            link.click();
        }

        // Копирование интерактивного графика (HTML)
        function copyInteractiveGraph(graphPath) {
            fetch(`/static/analyses/{{ analysis_id }}/${graphPath}`)
                .then(response => response.text())
                .then(html => {
                    const blob = new Blob([html], { type: 'text/html' });
                    const item = new ClipboardItem({ 'text/html': blob });
                    navigator.clipboard.write([item]).then(function() {
                        alert('HTML графика скопирован в буфер обмена!');
                    }, function(err) {
                        alert('Ошибка копирования: ' + err);
                    });
                });
        }
    </script>
</body>
</html> 